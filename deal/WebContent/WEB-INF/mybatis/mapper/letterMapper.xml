<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="letter">
	
	<!-- 쪽지 보내기 -->
	<insert id="insertLetter" parameterType="com.project.letter.Letter">
		
			INSERT INTO letter(content, sendUserId, receiveUserId, parent
                 ) VALUES ( #{content}, #{sendUserId}, #{receiveUserId}, 3)
                 
	</insert>
	
<!-- 	
	<sql id="where-list">
	  <if test="searchKey=='sendUserName' or searchKey=='receiveUserName'">
	      INSTR(userName, #{searchValue}) = 1
	  </if>
	  <if test="searchKey=='sendUserId' or searchKey=='receiveUserId'">
	      ${searchKey}=#{searchValue}
	  </if>
	  <if test="searchKey=='content'">
	      INSTR(content, #{searchValue}) &gt; 0
	  </if>
	</sql> -->
	
	<!-- 받은 쪽지 리스트 -->
    <select id="dataCountReceive" parameterType="map" resultType="Integer">
        SELECT NVL(COUNT(*), 0) 
                   FROM letter JOIN member
                   ON sendUserId=userId
                  <where>
	     	     	 receiveUserId = #{userId}
	     	          AND receiveDelete = 'N'
                  </where> 
    </select>
	
	<select id="listReceive" parameterType="String" resultType="com.project.letter.Letter">
		SELECT * FROM (
		    SELECT ROWNUM rnum, tb.* FROM (
			     SELECT num, content, sendUserId, 
                   TO_CHAR(sendDay, 'YYYY-MM-DD HH24:MI:SS') sendDay, 
                   NVL2(identifyDay, TO_CHAR(identifyDay, 'YYYY-MM-DD HH24:MI:SS'), null) identifyDay, 
                   sendDelete, receiveDelete, parent
                 FROM letter JOIN member ON sendUserId=userId
        <!--             <where>
	     	            <if test="searchValue!=null and searchValue!='' ">
	     	                <include refid="where-list"/>
	     	             </if>
	     	             AND receiveUserId = #{userId}
	     	             AND receiveDelete = 'N'
	                </where>
	                ORDER BY num DESC
	<![CDATA[
	        ) tb WHERE ROWNUM <= #{end}
		) WHERE rnum >= #{start}
	]]> -->
    </select>
	
	 <!-- 보낸 쪽지 리스트 -->
    <select id="dataCountSend" parameterType="map" resultType="Integer">
        SELECT NVL(COUNT(*), 0) 
                   FROM note JOIN member
                   ON receiveUserId=userId
                  <where>
	     	        
	     	          sendUserId = #{userId}
	     	          AND sendDelete = 'N'
                  </where> 
    </select>
    
    <select id="listSend" parameterType="String" resultType="com.project.letter.Letter">
		SELECT * FROM (
		    SELECT ROWNUM rnum, tb.* FROM (
			     SELECT num, content, receiveUserId, 
                    TO_CHAR(sendDay, 'YYYY-MM-DD HH24:MI:SS') sendDay, 
                    NVL2(identifyDay, TO_CHAR(identifyDay, 'YYYY-MM-DD HH24:MI:SS'), null) identifyDay, 
                    sendDelete, receiveDelete, parent
                   FROM letter JOIN member ON receiveUserId=userId
                  <!--   <where>
	     	             <if test="searchValue!=null and searchValue!='' ">
	     	                  <include refid="where-list"/>
	     	              </if>
	     	              AND sendUserId = #{userId}
	     	              AND sendDelete = 'N'
	                </where>
	                ORDER BY num DESC
	<![CDATA[
	        ) tb WHERE ROWNUM <= #{end}
		) WHERE rnum >= #{start}
	]]> -->
    </select>
	
	
	
	
	 <!-- 쪽지를확인상태로변경 -->
    <delete id="updateIdentifyDay" parameterType="Integer">
        UPDATE letter SET identifyDay = SYSDATE 
                 WHERE num=#{num} AND identifyDay IS NULL
    </delete>
</mapper>